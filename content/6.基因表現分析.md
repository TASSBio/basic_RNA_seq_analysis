# 基因表現分析

在前面的步驟中，我們獲得了序列比對資料。現在，我們將焦點轉移到基因座上。我們的目標是了解每個基因座上有多少讀序; 讀序的數量反映了基因的表現量。為了計算每個基因座上的讀序數量，我們將使用 Stringtie。然後，我們將利用這些數據輸入到 edgeR 中，進行差異表現量的統計分析

## 安裝必要軟體

若尚未在 *2.環境設置* 安裝 Stringtie 的人，請使用下面指令安裝。
### Stringtie
```bash
conda install -c bioconda stringtie
```
[Stringtie 官方網站](https://ccb.jhu.edu/software/stringtie/)

[Stringtie 手冊](https://ccb.jhu.edu/software/stringtie/index.shtml?t=manual)

### R 語言與 edgeR
```bash
conda install r-base=4.3.1
```

進入 R
```bash
R
```

在 R 命令列中，安裝 BiocManager、Ballgown、與必要相依套件 
```R
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("edgeR")

# 測試是否成功載入
library("edgeR")
packageDescription("edgeR")$Version
```
本範例的輸出為 4.0.16
```
[1] "4.0.16"
```
[edgeR 介紹](https://bioconductor.org/packages/release/bioc/html/edgeR.html)

[edgeR 手冊](https://bioconductor.org/packages/release/bioc/vignettes/edgeR/inst/doc/edgeRUsersGuide.pdf)

## 計算每個基因座讀序數

請依照實際情況修改 -G 選項路徑。

- -e 選項: 啟動表現量評估模式
- -p 選項: 使用的 CPU 數量
- -G 選項: 輸入註解檔案 gtf 存放位置 (產生方法請參照 3.數據準備)
- -o 選項: 輸出 gft 格式
- -A 選項: 輸出基因表現量表格
```bash
stringtie -e -p 8 \
-G UCSC_genome/dm6.ncbiRefSeq.gtf \
-o stringtie/gtf/SRR26539809/SRR26539809.transcripts.gtf \
-A stringtie/SRR26539809.gene_abund.tsv \
MQ30_bam/SRR26539809_aln_ddup_MQ30.bam
```
雖然我們在這個範例中開啟了 -o 選項，但我們並不打算使用所輸出的 gtf 文件。然而，考慮到 gtf 文件包含更詳細的輸出資訊，我們還是保留了這個選項。

以下是 SRR26539809.gene_abund.tsv 部份輸出內容
```
GeneID          GeneName        Reference  Strand  Start      End     Coverage   FPKM       TPM
CR11023         CR11023         chr2L      +       7529       9484    0.143085   0.228229   0.292408         
Ir21a           Ir21a           chr2L      -       21823      25155   0.000000   0.000000   0.000000         
asRNA:CR43609   asRNA:CR43609   chr2L      +       21952      24237   0.914350   1.458445   1.868560         
Cda5            Cda5            chr2L      -       25402      65404   0.082859   0.198545   0.254376         
lncRNA:CR46254  lncRNA:CR46254  chr2L      +       54817      55767   0.154574   0.246555   0.315886         
```

- 第一欄 基因 ID：基因編號來自於 -G 選項提供的註解檔案。
- 第二欄 基因名稱：基因名稱來自於 -G 選項提供的註解檔案。
- 第三欄 參考：用於讀序對齊的參考序列名稱。等同於 .SAM 對齊中的第三欄 (染色體編號)。
- 第四欄 / 方向：'+' 表示基因位於正股上，'-' 表示基因位於反股上。
- 第五欄 / 起始位置：基因的起始位置（以1為基底的索引）。
- 第六欄 / 終止位置：基因的終止位置（以1為基底的索引）。
- 第七欄 / 覆蓋率：基因的每個位置的覆蓋率。
- 第八欄 / FPKM：以 FPKM (Fragments Per Kilobase of transcript per Million mapped reads) 標準單位表示的表現量。
- 第九欄 / TPM：以 TPM (Transcripts Per Million) 標準單位表示的表現量。

以迴圈進行批次作業 (選擇性)
```bash
# Define the list of SRR identifiers
SRR=(SRR26539805 SRR26539806 SRR26539807 SRR26539809 SRR26539810 SRR26539811 SRR26539808 SRR26539812)

for i in "${SRR[@]}"; do
    echo "Processing $i..."

    # estimate expression
    stringtie -e -p 8 \
    -G UCSC_genome/dm6.ncbiRefSeq.gtf \
    -o stringtie/gtf/${i}/${i}.transcripts.gtf \
    -A stringtie/${i}.gene_abund.tsv \
    MQ30_bam/${i}_aln_ddup_MQ30.bam;
done
```

## 差異表現量分析統計

現在我們已經有每個樣本、每個基因的表現量資訊了。我們將使用 R 語言裡面的 edgeR 套件分析統計實驗組與對照組的基因表現差異。

>在本範例中。SRR26539805, SRR26539806, SRR26539807, SRR26539808 為四重複 RNA 實驗組樣本。
>而 SRR26539809, SRR26539810, SRR26539811, SRR26539812，為四重複 RNA 對照組樣本。
